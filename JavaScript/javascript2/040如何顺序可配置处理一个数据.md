---
ptitle:deal-with-result
date: 2018-05-03
categories: javascript

---
### 1 同步版本

```javascript
class Compose {
  constructor(){
    this.middleWares = [];
  }
  use(middleWare){
    if(typeof middleWare !== 'function'){
      throw new Error(`${middleWare} arguments is not a function `);
    }
    (this.middleWares || (this.middleWares = [])).push(middleWare);
  }
  send(ctx){
    let chain = this.middleWares.slice();
    if(this.middleWares.length === 0){
      throw new Error('there is no middleWare to send to');
    };
    let promise = Promise.resolve(ctx);
    while(chain.length){
      promise = promise.then(chain.shift()).catch((err)=>{
        console.log(err)
        // return Promise.reject(err);
      })
    };
    return promise;
  }
    //注意这个其实是有问题的，循环的时候，中间件同步的函数还是会先执行，只是每个函数内部异步会单个异步处理；
  sendReduce(ctx){
    let chain = this.middleWares.slice();
    if(this.middleWares.length === 0){
      throw new Error('there is no middleWare to send to');
    };
    return chain.reduce(async (ctx,middleWare) => {
      return await middleWare(ctx);
    },ctx);
  }
}

const compose = new Compose();
const result = {}
compose.use(async (ctx) => {
  console.log('1 s',ctx)
  ctx.body = 'hello';
  return await new Promise((resolve,reject) => {
    setTimeout(() => {
      console.log('1 e')
      
      ctx.asyncOperation = 'operation';
      // resolve(ctx);
      reject(ctx)
    })
  })
});
compose.use(async (ctx) => {
  console.log('2 s',ctx)
  ctx.name = 'hello'
  console.log('2 e');
  return ctx
});

// const resultSend1 = compose.send(result).then((data) => {
//   console.log('resolve-data',data)
// }).catch((data) => {
//   console.log('reject-data',data)
// })
const resultSend2 = compose.sendReduce(result).then((data) => {
  console.log('resolve-reduceData',data)
}).catch((data) => {
  console.log('reject-reduceData',data)
})
```

### 2 优化后版本 --支持异步

```javascript
class Blocker{
  // register interceptor
  applyMiddleWares(type,middleWares){ 
    if(typeof type !== 'string') {
      throw new Error(`${type} need to be string`)
    }
    const key = Object.keys(middleWares)[0];
    middleWares[key][0] = middleWares[key][0] || null;
    middleWares[key][1] = middleWares[key][1] || null;
    this[type] = this[type] || [];
    this[type].push(middleWares);
    console.log(this[type])
  };
  sendToMiddleWares(type,result,except = []){
    debugger;
    const chain = [];
    const middleWares = this[type]; //array
    if(!chain){
      throw new Error(`The ${type} interceptor is not defined`)
    }
    if(!Array.isArray(except)) {
      throw new Error(`The ${except} must be an Array`)
    }
    let promise = Promise.resolve(result);
    middleWares.forEach(function unshiftInterceptors(middleWare) {
      const key = Object.keys(middleWare)[0];
      if(!except.includes(key)) {
        chain.unshift(middleWare[key][0],middleWare[key][1]);
      }
    });
    while (chain.length) {
      promise = promise.then(chain.shift(),chain.shift());
    }
    return promise;
  };
  clear(type) {
    if(this[type]) {
      this[type] = [];
    }
  }
}  
// export new Blocker();
const blocker = new Blocker();
blocker.applyMiddleWares('req',{
  'url':[(result) => {
    // your operation
    return new Promise((resolve,reject) => {
      result.url = 'https://'+result.url;
      resolve(result)
    })
    // result.url = 'https://'+result.url;
    // return result
  },() => {
    console.log(reject)
  }],
});
blocker.applyMiddleWares('req',{
  'prefix':[(result) => {
    // your operation
    console.log(result)
    return new Promise((resolve,reject) => {
      result.prefix = 'httpsaaa://'+result.url;
      resolve(result)
    })
    // result.url = 'https://'+result.url;
    // return result
  },() => {
    console.log(reject)
  }],
});
blocker.applyMiddleWares('req',{
  'another':[(result) => {
    // your operation
    console.log(result)
    return new Promise((resolve,reject) => {
      result.another = 'httpssss://'+result.url;
      resolve(result)
    })
    // result.url = 'https://'+result.url;
    // return result
  },() => {
    console.log(reject)
  }],
});
const result = {url:'www.test.com'};
blocker.sendToMiddleWares('req',result);
// blocker.sendToMiddleWares('req',result,['another']);
```

